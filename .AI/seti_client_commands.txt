#include "client.h"

// REGIS: Registrazione
int send_regis(Client *client) {
    char message[BUFFER_SIZE];
    char port_str[PORT_LEN + 1];
    char pwd_bytes[3];
    
    encode_port(client->udp_port, port_str);
    encode_password(client->password, pwd_bytes);
    
    // Formato: REGIS id port mdp+++
    snprintf(message, BUFFER_SIZE, "REGIS %s %s", client->id, port_str);
    int len = strlen(message);
    message[len] = pwd_bytes[0];
    message[len + 1] = pwd_bytes[1];
    message[len + 2] = '+';
    message[len + 3] = '+';
    message[len + 4] = '+';
    message[len + 5] = '\0';
    
    if (send_tcp_message(client->tcp_socket, message) < 0) {
        return -1;
    }
    
    // Ricevi risposta
    char response[BUFFER_SIZE];
    if (receive_tcp_message(client->tcp_socket, response, BUFFER_SIZE) < 0) {
        return -1;
    }
    
    if (strncmp(response, "WELCO", 5) == 0) {
        printf("Registrazione accettata!\n");
        client->registered = 1;
        return 0;
    } else if (strncmp(response, "GOBYE", 5) == 0) {
        printf("Registrazione rifiutata dal server\n");
        close_connection(client);
        return -1;
    }
    
    return -1;
}

// CONNE: Connessione con credenziali
int send_conne(Client *client) {
    char message[BUFFER_SIZE];
    char pwd_bytes[3];
    
    encode_password(client->password, pwd_bytes);
    
    // Formato: CONNE id mdp+++
    snprintf(message, BUFFER_SIZE, "CONNE %s ", client->id);
    int len = strlen(message);
    message[len] = pwd_bytes[0];
    message[len + 1] = pwd_bytes[1];
    message[len + 2] = '+';
    message[len + 3] = '+';
    message[len + 4] = '+';
    message[len + 5] = '\0';
    
    if (send_tcp_message(client->tcp_socket, message) < 0) {
        return -1;
    }
    
    // Ricevi risposta
    char response[BUFFER_SIZE];
    if (receive_tcp_message(client->tcp_socket, response, BUFFER_SIZE) < 0) {
        return -1;
    }
    
    if (strncmp(response, "HELLO", 5) == 0) {
        printf("Connessione accettata!\n");
        client->registered = 1;
        return 0;
    } else if (strncmp(response, "GOBYE", 5) == 0) {
        printf("Connessione rifiutata dal server\n");
        close_connection(client);
        return -1;
    }
    
    return -1;
}

// FRIE?: Richiesta di amicizia
int send_frie_request(Client *client, const char *friend_id) {
    char message[BUFFER_SIZE];
    snprintf(message, BUFFER_SIZE, "FRIE? %s+++", friend_id);
    
    if (send_tcp_message(client->tcp_socket, message) < 0) {
        return -1;
    }