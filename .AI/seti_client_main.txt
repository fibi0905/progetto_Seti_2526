#include "client.h"

// Inizializza struttura client
void init_client(Client *client) {
    memset(client, 0, sizeof(Client));
    client->tcp_socket = -1;
    client->udp_socket = -1;
    client->connected = 0;
    client->registered = 0;
}

// Stampa menu
void print_menu() {
    printf("\n========== MENU ==========\n");
    printf("1. Registrarsi (REGIS)\n");
    printf("2. Connettersi (CONNE)\n");
    printf("3. Lista clienti (LIST)\n");
    printf("4. Richiesta amicizia (FRIE)\n");
    printf("5. Invia messaggio (MESS)\n");
    printf("6. Invia flood (FLOO)\n");
    printf("7. Consulta flussi (CONSU)\n");
    printf("8. Disconnettersi (IQUIT)\n");
    printf("0. Esci\n");
    printf("==========================\n");
    printf("Scelta: ");
}

// Loop principale del client
void run_client(Client *client) {
    int choice;
    char friend_id[ID_LEN + 1];
    char message[MAX_MESS_LEN + 1];
    
    while (1) {
        print_menu();
        if (scanf("%d", &choice) != 1) {
            printf("Input non valido\n");
            while (getchar() != '\n'); // Pulisci buffer
            continue;
        }
        getchar(); // Consuma newline
        
        switch (choice) {
            case 0:
                printf("Uscita...\n");
                if (client->connected) {
                    send_quit(client);
                }
                return;
                
            case 1: // REGIS
                if (client->connected) {
                    printf("Già connesso. Disconnettersi prima.\n");
                    break;
                }
                if (connect_to_server(client) == 0) {
                    send_regis(client);
                }
                break;
                
            case 2: // CONNE
                if (client->connected) {
                    printf("Già connesso.\n");
                    break;
                }
                if (connect_to_server(client) == 0) {
                    send_conne(client);
                }
                break;
                
            case 3: // LIST
                if (!client->connected) {
                    printf("Non connesso.\n");
                    break;
                }
                send_list_request(client);
                break;
                
            case 4: // FRIE
                if (!client->connected) {
                    printf("Non connesso.\n");
                    break;
                }
                printf("ID amico (8 caratteri): ");
                if (fgets(friend_id, sizeof(friend_id) + 1, stdin)) {
                    friend_id[strcspn(friend_id, "\n")] = 0;
                    if (strlen(friend_id) == ID_LEN) {
                        send_frie_request(client, friend_id);
                    } else {
                        printf("ID deve essere di 8 caratteri\n");
                    }
                }
                break;
                
            case 5: // MESS
                if (!client->connected) {
                    printf("Non connesso.\n");
                    break;
                }
                printf("ID destinatario (8 caratteri): ");
                if (fgets(friend_id, sizeof(friend_id) + 1, stdin)) {
                    friend_id[strcspn(friend_id, "\n")] = 0;
                    if (strlen(friend_id) != ID_LEN) {
                        printf("ID deve essere di 8 caratteri\n");
                        break;
                    }
                }
                printf("Messaggio (max 200 caratteri): ");
                if (fgets(message, sizeof(message), stdin)) {
                    message[strcspn(message, "\n")] = 0;
                    if (strlen(message) <= MAX_MESS_LEN) {
                        send_message(client, friend_id, message);
                    } else {
                        printf("Messaggio troppo lungo\n");
                    }
                }
                break;
                
            case 6: // FLOO
                if (!client->connected) {
                    printf("Non connesso.\n");
                    break;
                }
                printf("Messaggio flood (max 200 caratteri): ");
                if (fgets(message, sizeof(message), stdin)) {
                    message[strcspn(message, "\n")] = 0;
                    if (strlen(message) <= MAX_MESS_LEN) {
                        send_flood(client, message);
                    } else {
                        printf("Messaggio troppo lungo\n");
                    }
                }
                break;
                
            case 7: // CONSU
                if (!client->connected) {
                    printf("Non connesso.\n");
                    break;
                }
                send_consu(client);
                break;
                
            case 8: // IQUIT
                if (!client->connected) {
                    printf("Non connesso.\n");
                    break;
                }
                send_quit(client);
                break;
                
            default:
                printf("Scelta non valida\n");
        }
    }
}

int main(int argc, char *argv[]) {
    if (argc != 5) {
        printf("Uso: %s <id> <udp_port> <password> <server_ip:server_port>\n", argv[0]);
        printf("Esempio: %s alice123 7878 1010 127.0.0.1:8888\n", argv[0]);
        return 1;
    }
    
    Client client;
    init_client(&client);
    
    // Parsing argomenti
    strncpy(client.id, argv[1], ID_LEN);
    client.id[ID_LEN] = '\0';
    if (strlen(argv[1]) != ID_LEN) {
        printf("Errore: ID deve essere di 8 caratteri alfanumerici\n");
        return 1;
    }
    
    client.udp_port = atoi(argv[2]);
    if (client.udp_port >= 9999) {
        printf("Errore: porta UDP deve essere < 9999\n");
        return 1;
    }
    
    client.password = atoi(argv[3]);
    if (client.password > 65535) {
        printf("Errore: password deve essere tra 0 e 65535\n");
        return 1;
    }
    
    // Parsing server IP:port
    char *colon = strchr(argv[4], ':');
    if (!colon) {
        printf("Errore: formato server deve essere IP:porta\n");
        return 1;
    }
    
    *colon = '\0';
    strncpy(client.server_ip, argv[4], sizeof(client.server_ip) - 1);
    client.server_port = atoi(colon + 1);
    
    // Crea socket UDP
    client.udp_socket = create_udp_socket(client.udp_port);
    if (client.udp_socket < 0) {
        return 1;
    }
    
    // Avvia thread UDP
    if (pthread_create(&client.udp_thread, NULL, udp_listener_thread, &client) != 0) {
        perror("Errore creazione thread UDP");
        return 1;
    }
    
    printf("\n=== Client SETI ===\n");
    printf("ID: %s\n", client.id);
    printf("Porta UDP: %u\n", client.udp_port);
    printf("Password: %u\n", client.password);
    printf("Server: %s:%d\n", client.server_ip, client.server_port);
    printf("===================\n");
    
    // Esegui client
    run_client(&client);
    
    // Cleanup
    if (client.udp_socket >= 0) {
        close(client.udp_socket);
    }
    if (client.tcp_socket >= 0) {
        close(client.tcp_socket);
    }
    
    return 0;
}