#include "client.h"

// Crea socket TCP
int create_tcp_socket() {
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) {
        perror("Errore creazione socket TCP");
        return -1;
    }
    return sock;
}

// Crea socket UDP e fa bind sulla porta specificata
int create_udp_socket(uint16_t port) {
    int sock = socket(AF_INET, SOCK_DGRAM, 0);
    if (sock < 0) {
        perror("Errore creazione socket UDP");
        return -1;
    }
    
    struct sockaddr_in addr;
    memset(&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = INADDR_ANY;
    addr.sin_port = htons(port);
    
    if (bind(sock, (struct sockaddr*)&addr, sizeof(addr)) < 0) {
        perror("Errore bind socket UDP");
        close(sock);
        return -1;
    }
    
    printf("Socket UDP in ascolto sulla porta %u\n", port);
    return sock;
}

// Connessione al server
int connect_to_server(Client *client) {
    client->tcp_socket = create_tcp_socket();
    if (client->tcp_socket < 0) {
        return -1;
    }
    
    struct sockaddr_in server_addr;
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(client->server_port);
    
    if (inet_pton(AF_INET, client->server_ip, &server_addr.sin_addr) <= 0) {
        perror("Indirizzo IP non valido");
        close(client->tcp_socket);
        return -1;
    }
    
    if (connect(client->tcp_socket, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
        perror("Errore connessione al server");
        close(client->tcp_socket);
        return -1;
    }
    
    printf("Connesso al server %s:%d\n", client->server_ip, client->server_port);
    client->connected = 1;
    return 0;
}

// Chiude la connessione
void close_connection(Client *client) {
    if (client->tcp_socket >= 0) {
        close(client->tcp_socket);
        client->tcp_socket = -1;
    }
    client->connected = 0;
    printf("Connessione chiusa\n");
}

// Invia messaggio TCP
int send_tcp_message(int socket, const char *message) {
    int len = strlen(message);
    int sent = send(socket, message, len, 0);
    if (sent != len) {
        perror("Errore invio messaggio TCP");
        return -1;
    }
    print_verbose("SEND", message);
    return 0;
}

// Riceve messaggio TCP
int receive_tcp_message(int socket, char *buffer, int size) {
    memset(buffer, 0, size);
    
    // Leggi fino a trovare +++
    int total_read = 0;
    while (total_read < size - 1) {
        int n = recv(socket, buffer + total_read, 1, 0);
        if (n <= 0) {
            if (n == 0) {
                printf("Server ha chiuso la connessione\n");
            } else {
                perror("Errore ricezione messaggio TCP");
            }
            return -1;
        }
        
        total_read += n;
        
        // Controlla se abbiamo ricevuto +++
        if (total_read >= 3 && 
            buffer[total_read - 3] == '+' &&
            buffer[total_read - 2] == '+' &&
            buffer[total_read - 1] == '+') {
            buffer[total_read] = '\0';
            print_verbose("RECV", buffer);
            return total_read;
        }
    }
    
    printf("Errore: messaggio troppo lungo\n");
    return -1;
}